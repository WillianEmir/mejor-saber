// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ContenidoCurricular {
  id               String  @id @default(uuid())
  nombre           String
  descripcionCorta String?
  descripcionLarga String?
  imagen           String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  area   Area   @relation(fields: [areaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  areaId String @map("area_id")

  ejesTematicos EjeTematico[]

  @@index([areaId])
  @@map("contenidos_curriculares")
}

model EjeTematico {
  id               String  @id @default(uuid())
  nombre           String
  descripcionCorta String?
  descripcionLarga String?
  imagen           String?
  preguntaTematica String?
  relevanciaICFES  String?
  video            String?
  orden            Int?
  tipo             TipoEjeTematico?

  contenidoCurricular   ContenidoCurricular @relation(fields: [contenidoCurricularId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  contenidoCurricularId String              @map("contenido_curricular_id")

  preguntas               Pregunta[]             @relation("EjeTematicoPreguntas")
  ObjetivosAprendizaje    ObjetivoAprendizaje[]
  ActividadesInteractivas ActividadInteractiva[]
  SubTema                 SubTema[]
  progresos               ProgresoUsuario[]

  @@unique([contenidoCurricularId, nombre])
  @@index([contenidoCurricularId])
  @@map("ejes_tematicos")
}

enum TipoEjeTematico {
  TEORICO
  PRACTICO
  EVALUATIVO
}

enum TipoActividadInteractiva {
  RELACIONAR
  IDENTIFICAR
  GRAFICO
}

model ItemActividadInteractiva {
  id                String  @id @default(uuid())
  nombre            String
  match             String
  retroalimentacion String
  respuestaCorrecta Boolean @default(false)
  imagen            String?

  actividadInteractiva   ActividadInteractiva @relation(fields: [actividadInteractivaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  actividadInteractivaId String               @map("actividad_interactiva_id")

  @@index([actividadInteractivaId])
  @@map("items_actividad_interactiva")
}

model ActividadInteractiva {
  id          String  @id @default(uuid())
  nombre      String
  descripcion String
  completado  Boolean @default(false)
  avance      Float   @default(0.0)

  ItemActividadInteractiva ItemActividadInteractiva[]

  tipo   TipoActividadInteractiva
  imagen String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  ejeTematico   EjeTematico @relation(fields: [ejeTematicoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  ejeTematicoId String      @map("eje_tematico_id")
  progresos     ProgresoUsuario[]

  @@index([ejeTematicoId])
  @@map("actividades_interactivas")
}

model SubTema {
  id          String  @id @default(uuid())
  nombre      String
  descripcion String
  completado  Boolean @default(false)
  imagen      String?
  video       String?

  ejeTematico   EjeTematico @relation(fields: [ejeTematicoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  ejeTematicoId String      @map("eje_tematico_id")
  progresos     ProgresoUsuario[]

  @@index([ejeTematicoId])
  @@map("sub_temas")
}

model ProgresoUsuario {
  id         String  @id @default(uuid())
  completado Boolean @default(false)
  avance     Float   @default(0.0)

  usuario   User   @relation(fields: [usuarioId], references: [id])
  usuarioId String @map("usuario_id")

  ejeTematico   EjeTematico? @relation(fields: [ejeTematicoId], references: [id])
  ejeTematicoId String?      @map("eje_tematico_id")

  subTema   SubTema? @relation(fields: [subTemaId], references: [id])
  subTemaId String?  @map("sub_tema_id")

  actividadInteractiva   ActividadInteractiva? @relation(fields: [actividadInteractivaId], references: [id])
  actividadInteractivaId String?               @map("actividad_interactiva_id")

  @@unique([usuarioId, ejeTematicoId])
  @@unique([usuarioId, subTemaId])
  @@unique([usuarioId, actividadInteractivaId])
  @@index([usuarioId])
  @@map("progreso_usuario")
}

model ObjetivoAprendizaje {
  id          String @id @default(uuid())
  descripcion String

  EjeTematico   EjeTematico @relation(fields: [EjeTematicoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  EjeTematicoId String      @map("eje_tematico_id")

  @@index([EjeTematicoId])
  @@map("objetivos_aprendizaje")
}

model OpcionPregunta {
  id                String  @id @default(uuid())
  respuesta         String
  correcta          Boolean
  retroalimentacion String?

  pregunta   Pregunta @relation(fields: [preguntaId], references: [id], onDelete: Cascade)
  preguntaId String   @map("pregunta_id")

  SimulacroPregunta SimulacroPregunta[]

  @@index([preguntaId])
  @@map("opciones_pregunta")
}

model Pregunta {
  id        String  @id @default(uuid())
  contexto  String
  imagen    String?
  enunciado String
  groupFlag String?

  evidencia   Evidencia @relation(fields: [evidenciaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  evidenciaId String    @map("evidencia_id")

  ejesTematicos     EjeTematico[]       @relation("EjeTematicoPreguntas")
  opciones          OpcionPregunta[]
  SimulacroPregunta SimulacroPregunta[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([evidenciaId])
  @@map("preguntas")
}

model Area {
  id               String  @id @default(uuid())
  nombre           String  @unique
  descripcionCorta String?
  descripcionLarga String?
  imagen           String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contenidosCurriculares ContenidoCurricular[]
  competencias           Competencia[]

  @@map("areas")
}

model Competencia {
  id               String  @id @default(uuid())
  nombre           String
  descripcionCorta String?
  descripcionLarga String?
  imagen           String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  area         Area         @relation(fields: [areaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  afirmaciones Afirmacion[]
  Simulacro    Simulacro[]
  areaId       String       @map("area_id")

  @@unique([areaId, nombre])
  @@index([areaId])
  @@map("competencias")
}

model Afirmacion {
  id               String  @id @default(uuid())
  nombre           String
  descripcionCorta String?
  descripcionLarga String?
  imagen           String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  competencia   Competencia @relation(fields: [competenciaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  evidencias    Evidencia[]
  competenciaId String      @map("competencia_id")

  @@unique([competenciaId, nombre])
  @@index([competenciaId])
  @@map("afirmaciones")
}

model Evidencia {
  id               String  @id @default(uuid())
  nombre           String
  descripcionCorta String?
  descripcionLarga String?
  imagen           String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  afirmacion   Afirmacion @relation(fields: [afirmacionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  afirmacionId String     @map("afirmacion_id")

  preguntas Pregunta[]

  @@unique([afirmacionId, nombre])
  @@index([afirmacionId])
  @@map("evidencias")
}

enum Role {
  ADMIN
  ADMINSCHOOL
  USER
  DOCENTE
}

model User {
  id             String    @id @default(uuid())
  idDocument     String?
  email          String    @unique
  password       String
  firstName      String
  lastName       String?
  address        String?
  department     String?
  city           String?
  isActive       Boolean   @default(false) @map("is_active")
  avatar         String?
  phone          String?
  degree         String?
  activationDate DateTime? @map("activation_date")
  role           Role      @default(USER)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  school   School? @relation(fields: [schoolId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  schoolId String? @map("school_id")

  schoolSede   SchoolSede? @relation(fields: [schoolSedeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  schoolSedeId String?     @map("school_sede_id")

  simulacros       Simulacro[]
  UserSubscription UserSubscription[]
  progresos        ProgresoUsuario[]

  @@index([schoolId])
  @@index([schoolSedeId])
  @@map("users")
}

model School {
  id         String  @id @default(uuid())
  nombre     String
  email      String? @unique
  DANE       String  @unique
  address    String?
  department String?
  city       String?

  users User[]

  sedes SchoolSede[]

  @@map("schools")
}

model SchoolSede {
  id     String @id @default(uuid())
  nombre String
  DANE   String @unique

  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  schoolId String @map("school_id")

  User User[]

  @@index([schoolId])
  @@map("school_sedes")
}

model Simulacro {
  id String @id @default(uuid())

  score           Float? // The score of the simulacro
  duracionMinutos Int? // The duration of the simulacro in minutes

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id")

  competencia   Competencia @relation(fields: [competenciaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  competenciaId String      @map("competencia_id")

  preguntas SimulacroPregunta[]

  @@index([userId])
  @@index([competenciaId])
  @@map("simulacros")
}

model SimulacroPregunta {
  id String @id @default(uuid())

  simulacro   Simulacro @relation(fields: [simulacroId], references: [id], onDelete: Cascade)
  simulacroId String    @map("simulacro_id")

  pregunta   Pregunta @relation(fields: [preguntaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  preguntaId String   @map("pregunta_id")

  opcionSeleccionada   OpcionPregunta? @relation(fields: [opcionSeleccionadaId], references: [id], onDelete: SetNull)
  opcionSeleccionadaId String?         @map("opcion_seleccionada_id")

  correcta Boolean? // Was the selected answer correct?

  @@unique([simulacroId, preguntaId])
  @@index([simulacroId])
  @@index([preguntaId])
  @@index([opcionSeleccionadaId])
  @@map("simulacro_preguntas")
}

enum PlanName {
  FREE
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
}

model Plan {
  id             String   @id @default(uuid())
  name           PlanName @unique
  price          Float
  durationInDays Int      @map("duration_in_days")
  description    String?

  subscriptions UserSubscription[]

  @@map("planes")
}

model UserSubscription {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  planId String @map("plan_id")
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Restrict)

  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  status SubscriptionStatus

  payments Payment[]

  @@index([userId])
  @@index([planId])
  @@map("user_subscriptions")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

model Payment {
  id                 String           @id @default(uuid())
  userSubscriptionId String           @map("user_subscription_id")
  userSubscription   UserSubscription @relation(fields: [userSubscriptionId], references: [id], onDelete: Cascade)
  amount             Float
  status             PaymentStatus
  paymentGatewayId   String?          @map("payment_gateway_id") // ID de la transacci√≥n en la pasarela de pago
  createdAt          DateTime         @default(now()) @map("created_at")

  @@index([userSubscriptionId])
  @@map("payments")
}